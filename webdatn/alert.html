<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªá th·ªëng Gi√°m s√°t ƒê·ªông c∆° C√¥ng nghi·ªáp - Ch·∫©n ƒëo√°n L·ªói</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông m∆∞·ª£t m√† cho sidebar */
    .sidebar-item {
      transition: all 0.3s ease-in-out;
    }
    .sidebar-item:hover {
      transform: translateX(5px);
    }
    /* Hi·ªáu ·ª©ng cho main content */
    .main-content {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* ƒê√°nh d·∫•u m·ª•c active */
    .sidebar-item.active {
      background-color: rgba(255, 255, 255, 0.1);
      font-weight: bold;
      border-left: 4px solid #ffffff;
    }
    /* T√πy ch·ªânh b·∫£ng l·ªói */
    .error-table {
      width: 100%;
      border-collapse: collapse;
    }
    .error-table th, .error-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .error-table th {
      background-color: #f3f4f6;
      color: #374151;
      font-weight: bold;
    }
    .error-table tr:hover {
      background-color: #f9fafb;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans antialiased">

  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-gradient-to-b from-blue-700 to-blue-900 text-white shadow-xl">
      <div class="p-4 text-2xl font-extrabold border-b border-blue-500/30 flex items-center">
        <span class="mr-3">‚öôÔ∏è</span>Gi√°m s√°t ƒê·ªông c∆°
      </div>
      <nav class="mt-4">
        <ul>
          <li class="px-4 py-3 text-lg hover:bg-blue-600/80 cursor-pointer rounded-r-lg flex items-center sidebar-item">
            <a href="home.html" class="flex items-center w-full"><span class="mr-3">üè†</span> Home</a>
          </li>
          <li class="px-4 py-3 text-lg hover:bg-blue-600/80 cursor-pointer rounded-r-lg flex items-center sidebar-item">
            <a href="datarealtime.html" class="flex items-center w-full"><span class="mr-3">üìà</span> D·ªØ Li·ªáu Th·ªùi Gian Th·ª±c</a>
          </li>
          <li class="px-4 py-3 text-lg hover:bg-blue-600/80 cursor-pointer rounded-r-lg flex items-center sidebar-item active">
            <a href="alert.html" class="flex items-center w-full"><span class="mr-3">üîç</span> Chu·∫©n ƒêo√°n L·ªói</a>
          </li>
          <li class="px-4 py-3 text-lg hover:bg-blue-600/80 cursor-pointer rounded-r-lg flex items-center sidebar-item">
            <a href="history.html" class="flex items-center w-full"><span class="mr-3">üìã</span> L·ªãch S·ª≠ S·ª± c·ªë</a>
          </li>
          <li class="px-4 py-3 text-lg hover:bg-blue-600/80 cursor-pointer rounded-r-lg flex items-center sidebar-item">
            <a href="settings.html" class="flex items-center w-full"><span class="mr-3">‚öôÔ∏è</span> C√†i ƒê·∫∑t</a>
          </li>
          <li class="px-4 py-3 text-lg hover:bg-blue-600/80 cursor-pointer rounded-r-lg flex items-center sidebar-item">
            <a href="#" onclick="logout()" class="flex items-center w-full"><span class="mr-3">üö™</span> ƒêƒÉng Xu·∫•t</a>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- N·ªôi dung ch√≠nh -->
    <main class="flex-1 p-4 main-content overflow-y-auto h-full">
      <!-- Header -->
      <div class="flex flex-col items-center mb-4">
        <h1 class="text-2xl font-bold text-gray-800 text-center">Chu·∫©n ƒêo√°n L·ªói ƒê·ªông C∆° ƒêi·ªán</h1>
        <p class="text-sm text-gray-500 mt-1">C·∫≠p nh·∫≠t: <span id="current-time" class="font-semibold"></span></p>
      </div>

      <!-- B·∫£ng hi·ªÉn th·ªã l·ªói -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Danh s√°ch L·ªói/C·∫£nh b√°o</h3>
        <table class="error-table">
          <thead>
            <tr>
              <th>Th·ªùi gian</th>
              <th>Thi·∫øt b·ªã ID</th>
              <th>Lo·∫°i l·ªói</th>
              <th>Th√¥ng b√°o</th>
              <th>Tr·∫°ng th√°i</th>
            </tr>
          </thead>
          <tbody id="error-table-body"></tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    // H√†m ƒëƒÉng xu·∫•t
    function logout() {
      localStorage.removeItem("username");
      alert("ƒêƒÉng xu·∫•t th√†nh c√¥ng!");
      window.location.href = "login.html";
    }

    // C·∫≠p nh·∫≠t th·ªùi gian hi·ªán t·∫°i
    function updateTime() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleString('vi-VN');
    }
    updateTime();
    setInterval(updateTime, 1000);

    // Ng∆∞·ª°ng ch·∫©n ƒëo√°n l·ªói
    const THRESHOLDS = {
      temperature: 80, // ¬∞C
      vibration: 10, // mm/s (cho x, y, z)
      voltage: { min: 200, max: 250 }, // V
      current: 15 // A
    };

    // H√†m ki·ªÉm tra l·ªói d·ª±a tr√™n d·ªØ li·ªáu c·∫£m bi·∫øn
    function detectErrors(data) {
      const errors = [];
      data.forEach(item => {
        const timestamp = new Date(item.timestamp).toLocaleString('vi-VN');
        const deviceId = item.id || 1; // Gi·∫£ ƒë·ªãnh device_id (c√≥ th·ªÉ l·∫•y t·ª´ API devices n·∫øu c·∫ßn)

        // Ki·ªÉm tra nhi·ªát ƒë·ªô
        if (item.temperature > THRESHOLDS.temperature) {
          errors.push({
            timestamp,
            device_id: deviceId,
            alert: 'Nhi·ªát ƒë·ªô cao',
            message: `Nhi·ªát ƒë·ªô ${item.temperature}¬∞C v∆∞·ª£t ng∆∞·ª°ng ${THRESHOLDS.temperature}¬∞C`,
            status: 'new'
          });
        }

        // Ki·ªÉm tra rung ƒë·ªông
        if (item.x > THRESHOLDS.vibration) {
          errors.push({
            timestamp,
            device_id: deviceId,
            alert: 'Rung ƒë·ªông X cao',
            message: `Rung ƒë·ªông tr·ª•c X ${item.x} mm/s v∆∞·ª£t ng∆∞·ª°ng ${THRESHOLDS.vibration} mm/s`,
            status: 'new'
          });
        }
        if (item.y > THRESHOLDS.vibration) {
          errors.push({
            timestamp,
            device_id: deviceId,
            alert: 'Rung ƒë·ªông Y cao',
            message: `Rung ƒë·ªông tr·ª•c Y ${item.y} mm/s v∆∞·ª£t ng∆∞·ª°ng ${THRESHOLDS.vibration} mm/s`,
            status: 'new'
          });
        }
        if (item.z > THRESHOLDS.vibration) {
          errors.push({
            timestamp,
            device_id: deviceId,
            alert: 'Rung ƒë·ªông Z cao',
            message: `Rung ƒë·ªông tr·ª•c Z ${item.z} mm/s v∆∞·ª£t ng∆∞·ª°ng ${THRESHOLDS.vibration} mm/s`,
            status: 'new'
          });
        }

        // Ki·ªÉm tra ƒëi·ªán √°p
        if (item.voltage < THRESHOLDS.voltage.min || item.voltage > THRESHOLDS.voltage.max) {
          errors.push({
            timestamp,
            device_id: deviceId,
            alert: 'ƒêi·ªán √°p b·∫•t th∆∞·ªùng',
            message: `ƒêi·ªán √°p ${item.voltage}V ngo√†i kho·∫£ng ${THRESHOLDS.voltage.min}-${THRESHOLDS.voltage.max}V`,
            status: 'new'
          });
        }

        // Ki·ªÉm tra d√≤ng ƒëi·ªán
        if (item.current > THRESHOLDS.current) {
          errors.push({
            timestamp,
            device_id: deviceId,
            alert: 'Qu√° d√≤ng',
            message: `D√≤ng ƒëi·ªán ${item.current}A v∆∞·ª£t ng∆∞·ª°ng ${THRESHOLDS.current}A`,
            status: 'new'
          });
        }
      });
      return errors;
    }

    // H√†m l·∫•y d·ªØ li·ªáu c·∫£nh b√°o t·ª´ API v√† hi·ªÉn th·ªã
    async function fetchAndDisplayErrors() {
      try {
        // L·∫•y d·ªØ li·ªáu c·∫£m bi·∫øn
        const sensorResponse = await fetch('http://127.0.0.1:8000/L·∫•y d·ªØ li·ªáu t·ª´ Database/', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!sensorResponse.ok) {
          throw new Error('Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu c·∫£m bi·∫øn t·ª´ API');
        }
        const sensorData = await sensorResponse.json();

        // Ph√°t hi·ªán l·ªói t·ª´ d·ªØ li·ªáu c·∫£m bi·∫øn
        const detectedErrors = detectErrors(sensorData);

        // L·∫•y danh s√°ch c·∫£nh b√°o t·ª´ API
        const alertsResponse = await fetch('http://127.0.0.1:8000/L·∫•y danh s√°ch c·∫£nh b√°o', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!alertsResponse.ok) {
          throw new Error('Kh√¥ng th·ªÉ l·∫•y danh s√°ch c·∫£nh b√°o t·ª´ API');
        }
        const alerts = await alertsResponse.json();

        // K·∫øt h·ª£p l·ªói ph√°t hi·ªán v√† c·∫£nh b√°o t·ª´ API
        const allErrors = [...detectedErrors, ...alerts];

        // Hi·ªÉn th·ªã l·ªói trong b·∫£ng
        const tableBody = document.getElementById('error-table-body');
        tableBody.innerHTML = ''; // X√≥a n·ªôi dung c≈©
        allErrors.forEach(error => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${error.timestamp}</td>
            <td>${error.device_id}</td>
            <td>${error.alert}</td>
            <td>${error.message}</td>
            <td>${error.status}</td>
          `;
          tableBody.appendChild(row);
        });

      } catch (error) {
        console.error('L·ªói khi l·∫•y d·ªØ li·ªáu:', error);
        alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c server.');
      }
    }

    // G·ªçi h√†m l·∫•y v√† hi·ªÉn th·ªã l·ªói ngay khi t·∫£i trang
    fetchAndDisplayErrors();

    // C·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªói 10 gi√¢y
    setInterval(fetchAndDisplayErrors, 10000);
  </script>
</body>
</html>